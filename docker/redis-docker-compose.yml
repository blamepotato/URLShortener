version: '3'

services:
  redis-primary:
    image: redis:latest
    command: redis-server --appendonly yes --maxmemory <max-memory> --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - "/home/student/a2group02/redis-data:/data"
    deploy:
      placement:
        constraints: [node.role == manager]
      restart_policy:
        condition: on-failure
    networks:
      - redis-network
    
  redis-replica:
    image: redis:latest
    command: redis-server --replicaof redis-primary 6379 --maxmemory <max-memory> --maxmemory-policy allkeys-lru
    depends_on:
      - redis-primary
    deploy:
      placement:
        constraints: [node.role == worker]
      restart_policy:
        condition: on-failure
    networks:
      - redis-network

  python-redis-api:
    image: python-redis-api
    deploy:
      replicas: 4
      restart_policy:
        condition: on-failure
    volumes:
      - "/home/student/a2group02/app:/app"
    networks:
      - redis-network

networks:
  redis-network:
    