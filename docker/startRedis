#!/bin/bash
# This script sets up a Redis cluster and initializes a Docker Swarm

# Hardcoded IP addresses for the nodes
IP1="10.128.1.70"
IP2="10.128.2.70"
IP3="10.128.3.70"
IP4="10.128.4.70"

# Leave the swarm if already part of it
docker swarm leave --force

# Initialize the swarm on the primary node and capture the worker join token
JOIN_TOKEN=$(docker swarm init --advertise-addr "$IP1" | grep "docker swarm join --token" | awk '{ print $5 }')

# Join the other nodes to the swarm as worker nodes
for IP in $IP2 $IP3 $IP4; do
    ssh student@$IP "docker swarm leave --force; docker swarm join --token $JOIN_TOKEN $IP1:2377"
done

# Build the Python app Docker image
docker build -t python-app .

# Deploy the stack
docker stack deploy -c redis-docker-compose.yml redis_stack

